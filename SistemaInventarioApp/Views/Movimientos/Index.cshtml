@model IEnumerable<SistemaInventarioApp.Entidades.Movimiento>
@using SistemaInventarioApp.Entidades

<h2 class="mb-4">Historial de Movimientos</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-warning">
        @TempData["Error"]
    </div>
}

<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Buscar Producto</label>
                <input type="text" name="search" class="form-control" placeholder="Nombre o Código"
                       value="@ViewData["Search"]" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Fecha Inicio</label>
                <input type="date" name="fechaInicio" class="form-control" value="@ViewData["FechaInicio"]" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Fecha Fin</label>
                <input type="date" name="fechaFin" class="form-control" value="@ViewData["FechaFin"]" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Tipo Movimiento</label>
                <select name="tipo" class="form-select">
                    <option value="">Todos los tipos</option>
                    @foreach (var t in Enum.GetValues(typeof(TipoMovimiento)))
                    {
                        <option value="@t" selected="@(ViewData["TipoMovimiento"]?.ToString() == t.ToString() ? "selected" : null)">
                            @t
                        </option>                    }
                </select>
            </div>
            <div class="col-md-3 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                <a asp-action="Index" class="btn btn-secondary w-100">Limpiar</a>
            </div>
        </form>
    </div>
</div>

@* Agrupar movimientos por producto para mostrar un solo botón de "Eliminar Movimientos" por producto *@
@foreach (var grupo in Model.GroupBy(m => m.ProductoId))
{
    var producto = grupo.First().Producto;
    <div class="card mb-3 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>@producto.Nombre (@producto.CodigoBarras)</span>
            <form asp-action="EliminarMovimientos" method="post" class="d-inline">
                <input type="hidden" name="productoId" value="@producto.Id" />
                <button type="submit" class="btn btn-danger btn-sm"
                        onclick="return confirm('¿Está seguro que desea eliminar todos los movimientos de este producto?');">
                    Eliminar Movimientos
                </button>
            </form>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Cantidad</th>
                        <th>Tipo Movimiento</th>
                        <th>Fecha y Hora</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var m in grupo.OrderByDescending(x => x.Fecha))
                    {
                        <tr>
                            <td>@m.Cantidad</td>
                            <td>
                                @(m.Tipo == TipoMovimiento.NuevoProducto ? "Nuevo Producto" :
                                  m.Tipo == TipoMovimiento.Ingreso ? "Ingreso de Stock" :
                                  m.Tipo == TipoMovimiento.Salida ? "Salida de Stock" :
                                  m.Tipo.ToString())
                            </td>
                            <td>@m.Fecha.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td>
                                <a class="btn btn-danger btn-sm" asp-action="Delete" asp-route-id="@m.Id">Eliminar</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
